<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OLYMPIAN HOODIES | AXIOM</title>
    <style>
        :root { 
            --fire-glow: #ffae00; --fire-core: #ff4500;
            --header-h: 60px; --search-h: 65px;
        }

        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background: #000; font-family: 'Courier New', monospace; color: white;
            overflow: hidden; touch-action: manipulation;
        }

        /* Prevent Canvas from blocking clicks */
        canvas#fractalCanvas { position: fixed; top: 0; left: 0; z-index: 0; pointer-events: none; opacity: 0; transition: opacity 1s ease; }

        header { position: relative; z-index: 10; height: var(--header-h); display: flex; align-items: center; justify-content: center; background: transparent; }
        h1 { letter-spacing: 10px; color: var(--fire-glow); text-shadow: 0 0 15px var(--fire-core); font-size: 1.4rem; margin: 0; }

        .search-container { position: relative; z-index: 20; height: var(--search-h); display: flex; align-items: center; }
        #search-input { width: 90%; margin: 0 auto; padding: 12px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 69, 0, 0.5); color: var(--fire-glow); outline: none; border-radius: 0; }

        /* FORCED SQUARE GRID */
        #store-grid { 
            position: relative; z-index: 5; height: calc(100vh - 200px);
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; width: 95%; margin: 0 auto;
        }

        .card { 
            position: relative; background: transparent; border: 1px solid rgba(255, 69, 0, 0.2); 
            cursor: pointer; overflow: hidden; aspect-ratio: 1 / 1; 
            display: flex; flex-direction: column;
        }

        /* Expand/Collapse Logic */
        .card.expanded { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 100; background: rgba(0, 0, 0, 0.95); aspect-ratio: auto; }
        .slider-container { width: 100%; flex-grow: 1; position: relative; overflow: hidden; }
        .mockup-viewport { display: flex; height: 100%; overflow: hidden; scroll-behavior: smooth; }
        .mockup-viewport img { height: 100%; width: 100%; object-fit: contain; mix-blend-mode: lighten; }

        .action-row { height: 85px; display: none; grid-template-columns: 1fr 1.2fr 1.2fr; gap: 10px; padding: 15px; border-top: 1px solid var(--fire-core); }
        .card.expanded .action-row { display: grid; }

        .pagination-container { position: relative; z-index: 10; height: 50px; width: 100%; display: flex; align-items: center; justify-content: center; }
        .pagination-bar { display: flex; gap: 20px; overflow-x: auto; max-width: 80%; scrollbar-width: none; }
        .page-num { font-size: 1.2rem; color: rgba(255, 255, 255, 0.3); min-width: 30px; text-align: center; }
        .page-num.active { color: var(--fire-glow); font-weight: bold; }

        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 2.5rem; color: var(--fire-glow); z-index: 110; display: none; }
        .card.expanded .close-btn { display: block; }
        .grid-label { position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.6); text-align: center; font-size: 0.55rem; color: var(--fire-glow); padding: 4px 0; }
    </style>
</head>
<body>

<canvas id="fractalCanvas"></canvas>
<header><h1>OLYMPIAN HOODIES</h1></header>
<div class="search-container"><input type="text" id="search-input" placeholder="SCANNING ARCHIVE..." oninput="handleSearch()"></div>

<div id="store-grid">INITIALIZING SYSTEM...</div>

<div class="pagination-container">
    <div class="pagination-bar" id="pagination-bar"></div>
</div>

<script>
// --- GLOBAL DATA ---
let allProducts = [], filteredProducts = [], currentPage = 0;
const itemsPerPage = 4;

// --- STEP 1: DEFINE ENGINE FUNCTIONS (BUT DON'T START YET) ---
const canvas = document.getElementById('fractalCanvas');
const ctx = canvas.getContext('2d');
let w, h, worldY = 0, lastTreeY = 0, time = 0, treeSegments = [], particles = [];

function resize() {
    w = canvas.width = window.innerWidth;
    h = canvas.height = window.innerHeight;
}

// ... (FlameSpike, RealEmber, generateTree, loop functions stay exactly as you had them) ...
// [Logic omitted for brevity - Keep your tree code here]

// --- STEP 2: LOAD DATA FIRST ---
async function bootSequence() {
    try {
        const res = await fetch('/.netlify/functions/get-products');
        allProducts = await res.json();
    } catch (e) {
        // Safe fallback so the site never hangs
        allProducts = Array.from({length: 8}, (_, i) => ({ id: i, name: `OLYMPIAN v${i+1}`, images: ["https://via.placeholder.com/600/000"] }));
    }
    filteredProducts = allProducts;
    
    // RENDER THE GRID
    renderGrid();
    
    // --- STEP 3: START ANIMATION ONLY AFTER GRID IS READY ---
    resize();
    lastTreeY = h; 
    generateTree(w/2, h, -Math.PI/2, 120, 0);
    canvas.style.opacity = "1"; // Smooth fade in for the tree
    loop(); 
}

function renderGrid() {
    const grid = document.getElementById('store-grid');
    const items = filteredProducts.slice(currentPage * itemsPerPage, (currentPage + 1) * itemsPerPage);
    grid.innerHTML = items.map(p => `
        <div class="card" onclick="expandCard(this)">
            <div class="close-btn" onclick="event.stopPropagation(); shrinkCard(this.parentElement)">Ã—</div>
            <div class="slider-container" onclick="event.stopPropagation()">
                <div class="mockup-viewport" id="slider-${p.id}">${p.images.map(img => `<img src="${img}">`).join('')}</div>
            </div>
            <div class="action-row" onclick="event.stopPropagation()">
                <select class="size-select"><option>SIZE</option><option>S</option><option>M</option><option>L</option></select>
                <button class="buy-btn">FIAT</button><button class="buy-btn crypto">CRYPTO</button>
            </div>
            <div class="grid-label">${p.name}</div>
        </div>
    `).join('');
    renderPagination();
}

// ... (Pagination & Gesture logic here) ...

// KICK OFF THE BOOT SEQUENCE
window.onload = bootSequence;
</script>
</body>
</html>
